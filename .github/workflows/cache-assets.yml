name: Cache README Assets

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"  # every 12 hours

jobs:
  cache-readme-assets:
    runs-on: ubuntu-latest
    env:
      GH_USER: varshney565
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure assets dirs
        run: |
          mkdir -p assets
          mkdir -p assets/icons

      # -------- Cached stat cards --------
      - name: Fetch GitHub stats
        shell: bash
        run: |
          set -e
          url="https://github-readme-stats.vercel.app/api?username=${GH_USER}&show_icons=true&include_all_commits=true&count_private=true&cache_seconds=21600&theme=tokyonight"
          out="assets/github-stats.svg"
          curl -fL --retry 5 --retry-delay 5 "$url" -o "${out}.tmp" || true
          [ -s "${out}.tmp" ] && mv "${out}.tmp" "$out"

      - name: Fetch streak (stable domain)
        shell: bash
        run: |
          set -e
          url="https://streak-stats.demolab.com?user=${GH_USER}&theme=tokyonight"
          out="assets/github-streak.svg"
          curl -fL --retry 5 --retry-delay 5 "$url" -o "${out}.tmp" || true
          [ -s "${out}.tmp" ] && mv "${out}.tmp" "$out"

      - name: Fetch top languages
        shell: bash
        run: |
          set -e
          url="https://github-readme-stats.vercel.app/api/top-langs/?username=${GH_USER}&layout=compact&langs_count=10&cache_seconds=21600&theme=tokyonight"
          out="assets/top-langs.svg"
          curl -fL --retry 5 --retry-delay 5 "$url" -o "${out}.tmp" || true
          [ -s "${out}.tmp" ] && mv "${out}.tmp" "$out"

      - name: Fetch typing line (salesp07-style)
        shell: bash
        run: |
          set -e
          url="https://readme-typing-svg.demolab.com?font=Inter&weight=700&size=24&pause=900&duration=2600&color=00FFFF&center=true&vCenter=true&width=700&lines=Blockchain+Developer;Backend:+Rust+%7C+Go+%7C+Node.js;Competitive+Programmer"
          out="assets/typing.svg"
          curl -fL --retry 5 --retry-delay 5 "$url" -o "${out}.tmp" || true
          [ -s "${out}.tmp" ] && mv "${out}.tmp" "$out"

      - name: Fetch advanced trophies (matrix theme)
        shell: bash
        run: |
          set -e
          url="https://github-profile-trophy.vercel.app/?username=${GH_USER}&theme=matrix&no-bg=true&no-frame=true&column=6"
          out="assets/trophies-advanced.svg"
          curl -fL --retry 5 --retry-delay 5 "$url" -o "${out}.tmp" || true
          [ -s "${out}.tmp" ] && mv "${out}.tmp" "$out"

      # -------- Contribution Snake (correct inputs) --------
      - name: Generate snake (SVG)
        uses: Platane/snk/svg-only@v3
        continue-on-error: true
        with:
          github_user_name: ${{ env.GH_USER }}
          outputs: |
            assets/snake.svg?palette=github-dark

      # -------- 3D contribution graph (expects ENV, not inputs) --------
      - name: Generate 3D contrib graph
        uses: yoshi389111/github-profile-3d-contrib@0.7.1
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: ${{ env.GH_USER }}

      - name: Move 3D contrib into assets
        shell: bash
        run: |
          set -e
          if [ -f "profile-3d-contrib/profile-3d-contrib.svg" ]; then
            mv profile-3d-contrib/profile-3d-contrib.svg assets/profile-3d-contrib.svg
          elif [ -f "output/profile-3d-contrib.svg" ]; then
            mv output/profile-3d-contrib.svg assets/profile-3d-contrib.svg
          fi

      # -------- Commit if anything changed --------
      - name: Commit refreshed assets
        shell: bash
        run: |
          if [ -n "$(git status --porcelain assets)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add assets/*
            git commit -m "chore: refresh cached README assets"
            git push
          else
            echo "No changes detected"
          fi
